<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Common Key Finder</title>
  <style>
    :root{
      --bg0:#070a10;
      --bg1:#0b1020;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#e9eef7;
      --muted: rgba(233,238,247,.72);
      --muted2: rgba(233,238,247,.55);
      --accent:#69f0d6;
      --accent2:#8aa5ff;
      --danger:#ff6b8b;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --blur: 14px;
      --radius: 18px;
      --radius2: 14px;
      --tap: 44px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(105,240,214,.18), transparent 55%),
        radial-gradient(1200px 600px at 80% 10%, rgba(138,165,255,.18), transparent 55%),
        radial-gradient(800px 600px at 50% 120%, rgba(255,107,139,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px}

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      background: linear-gradient(180deg, rgba(7,10,16,.85), rgba(7,10,16,.55));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .head-inner{max-width:980px;margin:0 auto;padding:14px 14px 12px}

    .title-row{display:flex;align-items:center;justify-content:space-between;gap:12px}

    .brand{
      display:flex;flex-direction:column;gap:4px;min-width:0;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand p{margin:0;font-size:12px;color:var(--muted);line-height:1.2}

    .actions{display:flex;gap:10px;align-items:center}

    .btn{
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--text);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn[disabled]{opacity:.45;cursor:not-allowed;box-shadow:none}

    .btn .ic{width:18px;height:18px;opacity:.9}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
    }

    .selectors{margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px}

    .selector-card{padding:14px}
    .selector-grid{display:grid;grid-template-columns:1fr;gap:12px}

    .select-row{display:flex;align-items:stretch;gap:10px}

    .select-wrap{flex:1;display:flex;flex-direction:column;gap:8px}
    label{font-size:12px;color:var(--muted);letter-spacing:.2px}

    .select{
      display:flex;align-items:center;gap:10px;
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      transition:border-color .12s ease, background .12s ease;
    }

    .select:focus-within{border-color: rgba(105,240,214,.55);background: rgba(0,0,0,.30)}

    select{
      width:100%;
      background:transparent;
      border:none;
      color:var(--text);
      font-size:14px;
      outline:none;
      appearance:none;
      -webkit-appearance:none;
      padding-right:10px;
    }

    .select .chev{width:18px;height:18px;opacity:.7}

    .instrument-badge{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .instrument-badge svg{width:24px;height:24px}
    .instrument-badge .nm{font-size:14px}

    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .results{margin-top:14px;display:flex;flex-direction:column;gap:12px}

    .key-card{padding:14px;overflow:hidden}

    .key-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}

    .kname{display:flex;flex-direction:column;gap:4px;min-width:0}
    .kname .big{font-size:16px;font-weight:700}
    .kname .sub{font-size:12px;color:var(--muted)}

    .score-pill{
      min-width:84px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(105,240,214,.35);
      background: radial-gradient(160px 60px at 30% 30%, rgba(105,240,214,.20), rgba(255,255,255,.06));
      text-align:right;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .score-pill .num{font-family:var(--mono);font-weight:800}
    .score-pill .lbl{display:block;font-size:10px;color:var(--muted);margin-top:2px}

    .why{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.35}

    .bars{margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px}
    .bar-row{display:flex;align-items:center;gap:10px}
    .bar-row .tag{width:96px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bar{
      flex:1;height:10px;border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(105,240,214,.85), rgba(138,165,255,.80));
      border-radius:999px;
      transition: width .35s cubic-bezier(.2,.8,.2,1);
    }
    .bar-row .val{width:46px;text-align:right;font-family:var(--mono);font-size:12px;color:var(--muted)}

    .chips{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;color:var(--text);
    }
    .chip small{color:var(--muted2);font-size:11px}

    .tabs{margin-top:12px}
    .tablist{display:flex;gap:8px;flex-wrap:wrap}

    .tab{
      min-height:36px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--muted);
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease, color .12s ease;
    }
    .tab[aria-selected="true"]{
      color:var(--text);
      border-color: rgba(105,240,214,.45);
      background: rgba(105,240,214,.10);
    }

    .tabpanel{
      margin-top:10px;
      padding:12px;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      animation: fadeIn .18s ease;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(2px)}to{opacity:1;transform:translateY(0)}}

    .row2{display:grid;grid-template-columns:1fr;gap:12px}

    .section-title{font-size:12px;color:var(--muted);margin:0 0 8px 0;letter-spacing:.2px}

    .note-line{display:flex;flex-wrap:wrap;gap:8px}

    .note-chip{
      padding:8px 10px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      font-family:var(--mono);
      font-size:12px;
      display:inline-flex;gap:8px;align-items:center;
    }

    .note-chip .badges{display:flex;gap:6px;align-items:center}
    .badge{
      font-family:var(--mono);
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background: rgba(0,0,0,.18);
    }
    .badge.ok{border-color: rgba(105,240,214,.40); color: rgba(105,240,214,.95); background: rgba(105,240,214,.08)}

    .chord-grid{display:flex;flex-wrap:wrap;gap:8px}
    .chord-chip{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      display:inline-flex;gap:8px;align-items:center;
    }
    .chord-chip:active{transform: scale(.98)}
    .chord-chip:hover{border-color: rgba(255,255,255,.22)}
    .chord-chip[disabled]{opacity:.5;cursor:not-allowed}

    .deg{font-family:var(--mono);font-size:11px;color:var(--muted2)}
    .ch{font-family:var(--mono);font-size:12px}

    .mini{font-size:12px;color:var(--muted);line-height:1.35}

    .diagram-wrap{display:grid;grid-template-columns:1fr;gap:10px}
    .diagram-card{
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: rgba(255,255,255,.05);
      padding:10px;
    }

    .diagram-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .diagram-head .ttl{font-size:12px;color:var(--muted)}
    .diagram-head .chname{font-family:var(--mono);font-weight:700}

    canvas{width:100%;height:auto;display:block}

    .bowed-grid{display:grid;grid-template-columns:1fr;gap:10px}
    .kv{display:flex;gap:10px;align-items:flex-start}
    .kv b{min-width:110px;color:var(--muted);font-size:12px}
    .kv div{font-size:12px;color:var(--text);line-height:1.35}

    .footer{
      margin-top:18px;
      color:var(--muted2);
      font-size:11px;
      line-height:1.4;
      padding:12px 0 0;
    }

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color:var(--text);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: 0 16px 40px rgba(0,0,0,.5);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      font-size:12px;
      max-width:min(92vw, 520px);
      text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

    /* Desktop tweaks */
    @media (min-width: 820px){
      .selectors{grid-template-columns:1fr}
      .selector-grid{grid-template-columns:1fr}
      .bars{grid-template-columns:1fr 1fr}
      .row2{grid-template-columns: 1fr 1fr}
      .diagram-wrap{grid-template-columns: 1fr 1fr}
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important}
      .bar > i{transition:none}
      .tabpanel{animation:none}
      .btn{transition:none}
      .toast{transition:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div class="title-row">
        <div class="brand">
          <h1>Common Key Finder</h1>
          <p>Pick two instruments. Get the keys that feel great on both.</p>
        </div>
        <div class="actions">
          <button class="btn" id="swapBtn" disabled title="Swap instruments" aria-label="Swap instruments">
            <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 7h12m0 0-3-3m3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 17H5m0 0 3 3m-3-3 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Swap
          </button>
          <button class="btn" id="shareBtn" disabled title="Copy share link" aria-label="Copy share link">
            <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10 13a5 5 0 0 1 0-7l1.5-1.5a5 5 0 0 1 7 7L17 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M14 11a5 5 0 0 1 0 7L12.5 19.5a5 5 0 1 1-7-7L7 11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Share
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="selectors">
      <div class="card selector-card">
        <div class="selector-grid">
          <div class="select-row">
            <div class="select-wrap">
              <label for="selA">Instrument A</label>
              <div class="select">
                <span id="badgeA" class="instrument-badge" style="display:none"></span>
                <select id="selA" aria-label="Select Instrument A"></select>
                <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
            <div class="select-wrap">
              <label for="selB">Instrument B</label>
              <div class="select">
                <span id="badgeB" class="instrument-badge" style="display:none"></span>
                <select id="selB" aria-label="Select Instrument B"></select>
                <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="hint" id="hint">
            Select two instruments to see the top 5 key centers that tend to feel good on both.
            This is a simple, explainable heuristic: it favors open strings first, then chord-shape comfort (where it matters), then common jam keys, then key-signature simplicity.
          </div>
        </div>
      </div>
    </section>

    <section class="results" id="results" aria-live="polite"></section>

    <div class="footer">
      <div style="opacity:.95">
        <b style="color:var(--muted)">Heuristic weights (v1):</b>
        Open-string resonance 45% · Chord-shape friendliness 30% · Jam-key bonus 15% · Key signature simplicity 10%.
      </div>
      <div style="margin-top:6px">
        <b style="color:var(--muted)">Roadmap (not implemented in v1):</b>
        Jam Builder · Capo/Transposition Peacekeeper · More instruments & tunings · Mode toggle · Export “Jam Sheet”.
      </div>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Modal (used for chord diagrams from chips) -->
  <dialog id="dlg" style="border:none;background:transparent;padding:0;max-width:min(680px, 96vw)">
    <div class="card" style="padding:14px;border-radius:18px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-size:12px;color:var(--muted)">Chord diagram</div>
          <div id="dlgTitle" style="font-family:var(--mono);font-weight:800;font-size:16px"></div>
        </div>
        <button class="btn" id="dlgCloseBtn" aria-label="Close chord diagram">
          <svg class="ic" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Close
        </button>
      </div>
      <div id="dlgBody" style="margin-top:12px"></div>
      <div style="margin-top:10px;color:var(--muted2);font-size:11px;line-height:1.4">
        Tip: If a chord shape isn’t included in v1, the app will say so.
      </div>
    </div>
  </dialog>

  <script>
    /**********************
     * Common Key Finder — v1
     * Single-file app.
     *
     * Scoring notes:
     * - This is intentionally a heuristic, not a “theory engine”.
     * - The goal is fast, explainable ranking for jam-friendly key centers.
     *
     * Later features (DO NOT implement in v1):
     * - Common Notes Jam Builder: suggest 2–4 chords + a riff prompt per instrument.
     * - Transposition Peacekeeper: capo suggestions / alternate voicings / compromise keys.
     * - More instruments, custom tunings, capo param in URL.
     * - Mode toggle (major/minor/mixolydian) for Jam Builder.
     * - Export/print “Jam Sheet” layout.
     **********************/

    // -------------------------
    // Data
    // -------------------------

    const NOTE_ORDER_SHARPS = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]; // pitch classes 0..11
    const NOTE_ORDER_FLATS  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"]; // pitch classes 0..11

    const NOTE_TO_PC = {
      "C":0, "B#":0,
      "C#":1, "Db":1,
      "D":2,
      "D#":3, "Eb":3,
      "E":4, "Fb":4,
      "F":5, "E#":5,
      "F#":6, "Gb":6,
      "G":7,
      "G#":8, "Ab":8,
      "A":9,
      "A#":10, "Bb":10,
      "B":11, "Cb":11
    };

    const PC_TO_NAME = {
      sharps: (pc)=>NOTE_ORDER_SHARPS[(pc+12)%12],
      flats:  (pc)=>NOTE_ORDER_FLATS[(pc+12)%12]
    };

    const instruments = {
      guitar_std: {
        id:"guitar_std",
        name:"Guitar (Standard EADGBE)",
        family:"fretted",
        strings:["E","A","D","G","B","E"],
        icon:"guitar"
      },
      guitar_dropd: {
        id:"guitar_dropd",
        name:"Guitar (Drop D)",
        family:"fretted",
        strings:["D","A","D","G","B","E"],
        icon:"guitar"
      },
      ukulele: {
        id:"ukulele",
        name:"Ukulele (Standard GCEA)",
        family:"fretted",
        strings:["G","C","E","A"],
        icon:"ukulele"
      },
      bass: {
        id:"bass",
        name:"Bass Guitar (Standard EADG)",
        family:"bass",
        strings:["E","A","D","G"],
        icon:"bass"
      },
      violin: {
        id:"violin",
        name:"Violin (GDAE)",
        family:"bowed",
        strings:["G","D","A","E"],
        icon:"violin"
      },
      viola: {
        id:"viola",
        name:"Viola (CGDA)",
        family:"bowed",
        strings:["C","G","D","A"],
        icon:"viola"
      },
      cello: {
        id:"cello",
        name:"Cello (CGDA)",
        family:"bowed",
        strings:["C","G","D","A"],
        icon:"cello"
      },
      double_bass: {
        id:"double_bass",
        name:"Double Bass (EADG)",
        family:"bass",
        strings:["E","A","D","G"],
        icon:"doublebass"
      }
    };

    // Candidate keys — major + relative minor; scale tones are spelled simply for readability.
    const keys = [
      { id:"C",  major:"C",  relMinor:"Am",  prefer:"sharps", sigCount:0, sigText:"0",  scale:["C","D","E","F","G","A","B"] },
      { id:"G",  major:"G",  relMinor:"Em",  prefer:"sharps", sigCount:1, sigText:"1#", scale:["G","A","B","C","D","E","F#"] },
      { id:"D",  major:"D",  relMinor:"Bm",  prefer:"sharps", sigCount:2, sigText:"2#", scale:["D","E","F#","G","A","B","C#"] },
      { id:"A",  major:"A",  relMinor:"F#m", prefer:"sharps", sigCount:3, sigText:"3#", scale:["A","B","C#","D","E","F#","G#"] },
      { id:"E",  major:"E",  relMinor:"C#m", prefer:"sharps", sigCount:4, sigText:"4#", scale:["E","F#","G#","A","B","C#","D#"] },
      { id:"F",  major:"F",  relMinor:"Dm",  prefer:"flats",  sigCount:1, sigText:"1b", scale:["F","G","A","Bb","C","D","E"] },
      { id:"Bb", major:"Bb", relMinor:"Gm",  prefer:"flats",  sigCount:2, sigText:"2b", scale:["Bb","C","D","Eb","F","G","A"] },
      { id:"Eb", major:"Eb", relMinor:"Cm",  prefer:"flats",  sigCount:3, sigText:"3b", scale:["Eb","F","G","Ab","Bb","C","D"] }
    ];

    // Jam-key bonus (0..10)
    const jamKeyScore = {
      C: 8, G: 8, D: 8, A: 8, E: 8, F: 7, Bb: 5, Eb: 3
    };

    // Key-signature simplicity (0..10). Lower count = higher score.
    // 0 -> 10, 1 -> 8, 2 -> 6, 3 -> 4, 4 -> 2.
    const sigSimpScore = (sigCount)=>{
      const score = 10 - (sigCount*2);
      return clamp(score, 0, 10);
    };

    // Chord-shape friendliness (0..10)
    // (Very small / opinionated map; easy-to-explain “campfire” heuristics.)
    const chordFriendly = {
      guitar: { C:10, G:10, D:10, A:9, E:9, F:6, Bb:4, Eb:3 },
      uke:    { C:10, G:9,  D:9,  F:10, A:7, E:6, Bb:5, Eb:4 },
      neutral:{ C:5,  G:5,  D:5,  A:5, E:5, F:5, Bb:5, Eb:5 }
    };

    // Chord shapes dictionary (v1). Values are per-instrument family.
    // Representation:
    //   -1 = muted, 0 = open, n = fret.
    // IMPORTANT: This is intentionally small — we only include common “jam set” chords for likely keys.
    const chordShapes = {
      guitar: {
        "C":  { strings:[-1,3,2,0,1,0] },
        "G":  { strings:[3,2,0,0,0,3] },
        "D":  { strings:[-1,-1,0,2,3,2] },
        "A":  { strings:[-1,0,2,2,2,0] },
        "E":  { strings:[0,2,2,1,0,0] },
        "F":  { strings:[1,3,3,2,1,1], note:"barre" },
        "Bb": { strings:[-1,1,3,3,3,1], note:"barre" },
        "Eb": { strings:[-1,-1,1,3,4,3], note:"shape" },

        "Am": { strings:[-1,0,2,2,1,0] },
        "Em": { strings:[0,2,2,0,0,0] },
        "Bm": { strings:[-1,2,4,4,3,2], note:"barre" },
        "F#m":{ strings:[2,4,4,2,2,2], note:"barre" },
        "C#m":{ strings:[-1,4,6,6,5,4], note:"barre" },
        "Dm": { strings:[-1,-1,0,2,3,1] },
        "Gm": { strings:[3,5,5,3,3,3], note:"barre" },
        "Cm": { strings:[-1,3,5,5,4,3], note:"barre" }
      },
      ukulele: {
        "C":  { strings:[0,0,0,3] },
        "G":  { strings:[0,2,3,2] },
        "D":  { strings:[2,2,2,0] },
        "A":  { strings:[2,1,0,0] },
        "E":  { strings:[1,4,0,2], note:"common" },
        "F":  { strings:[2,0,1,0] },
        "Bb": { strings:[3,2,1,1] },
        "Eb": { strings:[0,3,3,1] },

        "Am": { strings:[2,0,0,0] },
        "Em": { strings:[0,4,3,2] },
        "Bm": { strings:[4,2,2,2], note:"barre" },
        "F#m":{ strings:[2,1,2,0] },
        "C#m":{ strings:[1,1,0,4], note:"common" },
        "Dm": { strings:[2,2,1,0] },
        "Gm": { strings:[0,2,3,1] },
        "Cm": { strings:[0,3,3,3], note:"barre" }
      }
    };

    // -------------------------
    // UI helpers
    // -------------------------

    const $ = (sel, el=document)=>el.querySelector(sel);
    const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));

    const toastEl = $("#toast");
    let toastT = null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function pc(note){
      return NOTE_TO_PC[note] ?? null;
    }

    function uniq(arr){
      return Array.from(new Set(arr));
    }

    function noteInScale(noteName, scale){
      // Compare by pitch class so Bb matches A# (though we display key-preferred spelling).
      const nPc = pc(noteName);
      const scalePcs = scale.map(pc);
      return scalePcs.includes(nPc);
    }

    function keyInfoById(id){
      return keys.find(k=>k.id===id);
    }

    function getInstrument(id){
      return instruments[id] || null;
    }

    function iconSVG(kind){
      // Simple inline icons; intentionally minimal.
      const common = 'fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"';
      switch(kind){
        case "guitar":
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path ${common} d="M15 3c2 1 3 3 2 5l-2 3-2 2-2 1-1 2 2 2c1 1 1 3 0 4-1 1-3 1-4 0l-2-2c-1-1-1-3 0-4 1-1 3-1 4 0l1 1 2-1 1-2 2-2 2-3"/><circle ${common} cx="8" cy="17" r="1.2"/></svg>`;
        case "ukulele":
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path ${common} d="M14 3c2 1 3 3 2 5l-2 3-1 1-2 1-1 2 2 2c1 1 1 3 0 4-1 1-3 1-4 0l-2-2c-1-1-1-3 0-4 1-1 3-1 4 0l1 1 2-1"/><path ${common} d="M18 4l3 3"/></svg>`;
        case "bass":
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path ${common} d="M16 3c2 1 3 3 2 5l-2 3-2 2-2 1-1 2 2 2c1 1 1 3 0 4-1 1-3 1-4 0l-2-2c-1-1-1-3 0-4 1-1 3-1 4 0l1 1 2-1"/><path ${common} d="M18 3h4v4"/></svg>`;
        case "violin":
        case "viola":
        case "cello":
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path ${common} d="M12 2c2 0 4 2 4 4 0 1-.4 2-1.1 2.8l-1.3 1.4v2l1 1.2c.9 1.1.9 2.8 0 3.9l-1.8 2.2c-.9 1.1-2.5 1.1-3.4 0l-1.8-2.2c-.9-1.1-.9-2.8 0-3.9l1-1.2v-2L9.1 8.8C8.4 8 8 7 8 6c0-2 2-4 4-4Z"/><path ${common} d="M8 12h8"/></svg>`;
        case "doublebass":
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><path ${common} d="M13 2c2 0 4 2 4 4 0 1-.4 2-1.1 2.8l-1.3 1.4v2l1.2 1.4c1 1.2 1 3.1 0 4.3l-1.8 2.3c-1 1.2-2.7 1.2-3.7 0l-1.8-2.3c-1-1.2-1-3.1 0-4.3l1.2-1.4v-2L10.1 8.8C9.4 8 9 7 9 6c0-2 2-4 4-4Z"/><path ${common} d="M18 3h4v4"/><path ${common} d="M7 14h10"/></svg>`;
        default:
          return `<svg viewBox="0 0 24 24" aria-hidden="true"><circle ${common} cx="12" cy="12" r="9"/></svg>`;
      }
    }

    function badgeHTML(inst){
      return `${iconSVG(inst.icon)}<div class="nm">${escapeHtml(inst.name)}</div>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // -------------------------
    // Music logic (simple heuristic)
    // -------------------------

    function relativeMinorNotes(key){
      // Same pitch classes, rotated to start on relative minor tonic.
      const rel = key.relMinor;
      const relRoot = rel.replace("m","");
      const idx = key.scale.findIndex(n => pc(n)===pc(relRoot));
      if(idx<0) return key.scale.slice();
      return key.scale.slice(idx).concat(key.scale.slice(0, idx));
    }

    function diatonicChordsMajor(key){
      // I ii iii IV V vi vii°
      const degrees = ["I","ii","iii","IV","V","vi","vii°"];
      const qualities = ["maj","min","min","maj","maj","min","dim"]; // triads
      const roots = key.scale;
      return roots.map((r,i)=>({
        degree: degrees[i],
        root: r,
        quality: qualities[i],
        name: chordName(r, qualities[i])
      }));
    }

    function chordName(root, quality){
      if(quality==="maj") return root;
      if(quality==="min") return root + "m";
      if(quality==="dim") return root + "dim";
      return root;
    }

    function jamSetForKey(key){
      // I / IV / V / vi
      const diat = diatonicChordsMajor(key);
      const map = Object.fromEntries(diat.map(d=>[d.degree, d]));
      return [map["I"], map["IV"], map["V"], map["vi"]].filter(Boolean);
    }

    function openResonanceScore(inst, key){
      const opens = inst.strings;
      const inScale = opens.filter(n => noteInScale(n, key.scale));
      const count = inScale.length;
      const max = opens.length;

      // Base: ratio scaled to 0..6
      let score = (count / max) * 6;

      const tonic = key.major;
      const domPc = (pc(tonic) + 7) % 12;

      // Bonus if tonic or dominant is open
      if(opens.some(n => pc(n)===pc(tonic))) score += 2;
      if(opens.some(n => pc(n)===domPc)) score += 1;

      // Bass friendliness: extra for low open roots (E/A especially)
      if(inst.family === "bass"){
        const lowFav = ["E","A"]; // emphasize common low roots
        for(const fav of lowFav){
          if(opens.some(n => pc(n)===pc(fav)) && noteInScale(fav, key.scale)) score += 0.6;
          if(opens.some(n => pc(n)===pc(fav)) && (pc(fav)===pc(tonic) || pc(fav)===domPc)) score += 0.8;
        }
      }

      // Cap
      score = clamp(score, 0, 10);
      return {
        score,
        openInScaleCount: count,
        openInScale: inScale
      };
    }

    function chordFriendlinessScore(inst, key){
      const k = key.id;
      if(inst.id === "guitar_std" || inst.id === "guitar_dropd") return chordFriendly.guitar[k] ?? 5;
      if(inst.id === "ukulele") return chordFriendly.uke[k] ?? 5;
      // Bowed strings & bass: neutral (don’t penalize)
      return chordFriendly.neutral[k] ?? 5;
    }

    function jamBonusScore(key){
      return jamKeyScore[key.id] ?? 4;
    }

    function keySigScore(key){
      return sigSimpScore(key.sigCount);
    }

    function instrumentEase(inst, key){
      const open = openResonanceScore(inst, key);
      const chord = chordFriendlinessScore(inst, key);
      const jam = jamBonusScore(key);
      const sig = keySigScore(key);

      const ease0to10 = (
        0.45*open.score +
        0.30*chord +
        0.15*jam +
        0.10*sig
      );

      return {
        ease0to10: clamp(ease0to10, 0, 10),
        ease0to100: clamp(ease0to10*10, 0, 100),
        parts: { open: open.score, chord, jam, sig },
        openDetails: open
      };
    }

    function overlapBonus(aDetails, bDetails, key){
      // Reward:
      // - both instruments having open strings in-scale
      // - and a dense pool of “safe notes” (the key scale itself)
      //
      // v1 definition of "overlap strength":
      //   - min(openInScaleCount) boosts
      //   - and we mildly reward keys with simple, jam-friendly scales by using scale size (always 7) and a tiny tonic/dominant presence bonus.
      const minOpen = Math.min(aDetails.openDetails.openInScaleCount, bDetails.openDetails.openInScaleCount);
      let bonus = minOpen * 1.6; // up to ~6.4 for 4 open strings, ~9.6 for 6

      const tonic = key.major;
      const domPc = (pc(tonic)+7)%12;
      const hasTonicOpenBoth = aDetails.openDetails.openInScale.some(n=>pc(n)===pc(tonic)) && bDetails.openDetails.openInScale.some(n=>pc(n)===pc(tonic));
      const hasDomOpenBoth = aDetails.openDetails.openInScale.some(n=>pc(n)===domPc) && bDetails.openDetails.openInScale.some(n=>pc(n)===domPc);
      if(hasTonicOpenBoth) bonus += 2;
      if(hasDomOpenBoth) bonus += 1;

      // Keep it small.
      return clamp(bonus, 0, 10);
    }

    function combinedScore(instA, instB, key){
      const a = instrumentEase(instA, key);
      const b = instrumentEase(instB, key);

      const avg = (a.ease0to100 + b.ease0to100) / 2;
      const ov = overlapBonus(a, b, key); // 0..10
      const combined = clamp(avg + ov, 0, 100);

      return { combined, a, b, overlap: ov };
    }

    // -------------------------
    // Explainability helpers
    // -------------------------

    function explainWhy(inst, key, details){
      const bits = [];
      const openNames = details.openDetails.openInScale;
      if(openNames.length){
        bits.push(`open strings in key: ${openNames.join("/")}`);
      }
      // Tonic / dominant quick mention
      const tonic = key.major;
      const domPc = (pc(tonic)+7)%12;
      const tonicOpen = inst.strings.some(n=>pc(n)===pc(tonic));
      const domOpen = inst.strings.some(n=>pc(n)===domPc);
      if(tonicOpen) bits.push(`tonic (${tonic}) is open`);
      else if(domOpen) bits.push(`dominant is open`);

      if(inst.id === "guitar_std" || inst.id === "guitar_dropd"){
        const c = chordFriendly.guitar[key.id] ?? 5;
        if(c>=9) bits.push("campfire chords feel natural");
        else if(c<=4) bits.push("more awkward guitar chord shapes");
      }
      if(inst.id === "ukulele"){
        const c = chordFriendly.uke[key.id] ?? 5;
        if(c>=9) bits.push("easy uke shapes for I/IV/V");
        else if(c<=4) bits.push("fewer beginner-friendly uke shapes");
      }
      if(inst.family === "bass"){
        // Mention low-root friendliness
        const low = inst.strings[0]; // E or D
        if(noteInScale(low, key.scale) && (pc(low)===pc(key.major) || pc(low)===((pc(key.major)+7)%12))){
          bits.push(`low open ${low} supports roots`);
        }
      }
      // Jam key
      if((jamKeyScore[key.id] ?? 0) >= 7) bits.push("common jam key");

      // Keep it short
      return bits.slice(0, 3).join(" + ");
    }

    function safeNoteBadges(note, instA, instB, key){
      const isOpenA = instA ? instA.strings.some(n=>pc(n)===pc(note)) : false;
      const isOpenB = instB ? instB.strings.some(n=>pc(n)===pc(note)) : false;
      const tonic = key.major;
      const domPc = (pc(tonic)+7)%12;
      const isTonic = pc(note)===pc(tonic);
      const isDom = pc(note)===domPc;

      const badges = [];
      if(isTonic) badges.push({txt:"tonic", ok:true});
      else if(isDom) badges.push({txt:"dominant", ok:true});
      if(isOpenA) badges.push({txt:"open A", ok:true});
      if(isOpenB) badges.push({txt:"open B", ok:true});

      return badges;
    }

    // -------------------------
    // Fingerings helpers
    // -------------------------

    function renderBowedFingerings(inst, key){
      // “First-position friendly notes” (very simplified):
      // For each open string, consider notes within 0, +2, +4, +5, +7 semitones (open..4th finger).
      // Then intersect with the key’s scale tones.
      const stepSet = [0,2,4,5,7];
      const pref = key.prefer;

      const byString = inst.strings.map(openName => {
        const base = pc(openName);
        const reachablePcs = stepSet.map(s => (base + s) % 12);
        const scalePcs = key.scale.map(pc);
        const friendly = reachablePcs
          .filter(p => scalePcs.includes(p))
          .map(p => {
            // Display using key preference
            const name = pref === "flats" ? PC_TO_NAME.flats(p) : PC_TO_NAME.sharps(p);
            // But if key.scale contains a spelled version of this pitch class, prefer that.
            const spelled = key.scale.find(n => pc(n)===p);
            return spelled || name;
          });
        return { open: openName, notes: uniq(friendly) };
      });

      const pattern = "W W H W W W H";

      const rows = byString.map(s => {
        return `<div class="kv"><b>${escapeHtml(s.open)} string</b><div>${s.notes.length ? s.notes.map(n=>`<span class=\"note-chip\">${escapeHtml(n)}</span>`).join(" ") : `<span class=\"mini\">No very-easy first-position scale tones (v1 heuristic)</span>`}</div></div>`;
      }).join("");

      return `
        <div class="bowed-grid">
          <div class="kv"><b>Open strings</b><div>${inst.strings.map(n=>`<span class="note-chip">${escapeHtml(n)}</span>`).join(" ")}</div></div>
          <div class="kv"><b>Pattern hint</b><div><span class="note-chip">Major: ${pattern}</span></div></div>
          <div>
            <div class="section-title">First-position friendly notes (by string)</div>
            ${rows}
          </div>
        </div>
      `;
    }

    function shapeForInstrument(inst, chord){
      // We render shapes only for guitar/uke.
      if(inst.id === "guitar_std" || inst.id === "guitar_dropd"){
        return chordShapes.guitar[chord] || null;
      }
      if(inst.id === "ukulele"){
        return chordShapes.ukulele[chord] || null;
      }
      return null;
    }

    function renderChordDiagramCanvas(targetEl, inst, chordNameStr, shape){
      // Minimal chord diagram renderer.
      // Uses a canvas so it looks crisp and consistent.
      const isGuitar = (inst.id === "guitar_std" || inst.id === "guitar_dropd");
      const stringsCount = isGuitar ? 6 : 4;
      const fretsToShow = 5;
      const pad = 18;
      const w = 360;
      const h = 220;

      const cnv = document.createElement("canvas");
      cnv.width = w;
      cnv.height = h;
      cnv.setAttribute("aria-label", `${inst.name} chord diagram for ${chordNameStr}`);

      const ctx = cnv.getContext("2d");
      ctx.clearRect(0,0,w,h);

      // Colors (keep simple; no custom palettes)
      const stroke = "rgba(255,255,255,.55)";
      const faint = "rgba(255,255,255,.18)";
      const text = "rgba(233,238,247,.88)";
      const muted = "rgba(233,238,247,.62)";
      const dot = "rgba(105,240,214,.92)";

      // Determine fret offset (if shapes are high up)
      const frets = shape.strings.filter(v=>v>0);
      const minF = frets.length ? Math.min(...frets) : 1;
      const maxF = frets.length ? Math.max(...frets) : 1;
      const offset = (maxF > fretsToShow) ? minF : 1;

      // Grid area
      const gx0 = pad + 30;
      const gy0 = pad + 18;
      const gx1 = w - pad;
      const gy1 = h - pad - 20;

      // Draw strings
      for(let s=0;s<stringsCount;s++){
        const x = gx0 + (s*(gx1-gx0)/(stringsCount-1));
        ctx.beginPath();
        ctx.moveTo(x, gy0);
        ctx.lineTo(x, gy1);
        ctx.strokeStyle = (s===0 || s===stringsCount-1) ? stroke : faint;
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      // Draw frets
      for(let f=0; f<=fretsToShow; f++){
        const y = gy0 + (f*(gy1-gy0)/fretsToShow);
        ctx.beginPath();
        ctx.moveTo(gx0, y);
        ctx.lineTo(gx1, y);
        ctx.strokeStyle = (f===0 && offset===1) ? stroke : faint;
        ctx.lineWidth = (f===0 && offset===1) ? 2 : 1;
        ctx.stroke();
      }

      // Fret number label if offset > 1
      if(offset>1){
        ctx.fillStyle = muted;
        ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
        ctx.fillText(`${offset}fr`, pad, gy0+8);
      }

      // Open/mute markers + dots
      const vals = shape.strings.slice(0, stringsCount);
      ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
      ctx.textAlign = "center";

      for(let s=0;s<stringsCount;s++){
        const v = vals[s];
        const x = gx0 + (s*(gx1-gx0)/(stringsCount-1));

        if(v === -1){
          ctx.fillStyle = "rgba(255,107,139,.85)";
          ctx.fillText("x", x, gy0-10);
        } else if(v === 0){
          ctx.fillStyle = text;
          ctx.fillText("o", x, gy0-10);
        } else if(v > 0){
          const fret = v - offset + 1;
          const y = gy0 + (fret - 0.5) * (gy1-gy0)/fretsToShow;
          ctx.beginPath();
          ctx.arc(x, y, 9, 0, Math.PI*2);
          ctx.fillStyle = dot;
          ctx.fill();
          ctx.strokeStyle = "rgba(0,0,0,.25)";
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }

      targetEl.appendChild(cnv);
    }

    // -------------------------
    // Render
    // -------------------------

    const selA = $("#selA");
    const selB = $("#selB");
    const badgeA = $("#badgeA");
    const badgeB = $("#badgeB");
    const resultsEl = $("#results");
    const swapBtn = $("#swapBtn");
    const shareBtn = $("#shareBtn");

    function fillSelect(el){
      const options = [
        {id:"", name:"Select an instrument…"},
        ...Object.values(instruments).map(i=>({id:i.id,name:i.name}))
      ];
      el.innerHTML = options.map(o=>`<option value="${o.id}">${escapeHtml(o.name)}</option>`).join("");
    }

    function setBadge(badgeEl, instId){
      if(!instId){
        badgeEl.style.display = "none";
        badgeEl.innerHTML = "";
        return;
      }
      const inst = getInstrument(instId);
      if(!inst){
        badgeEl.style.display = "none";
        badgeEl.innerHTML = "";
        return;
      }
      badgeEl.style.display = "flex";
      badgeEl.innerHTML = badgeHTML(inst);
    }

    function render(){
      const aId = selA.value;
      const bId = selB.value;
      setBadge(badgeA, aId);
      setBadge(badgeB, bId);

      const ready = !!aId && !!bId && aId !== bId;
      swapBtn.disabled = !ready;
      shareBtn.disabled = !ready;

      if(!ready){
        resultsEl.innerHTML = "";
        if(aId && bId && aId === bId){
          resultsEl.innerHTML = `<div class="card" style="padding:14px;border-radius:18px;border-color:rgba(255,107,139,.25)">
            <div style="color:rgba(255,107,139,.95);font-weight:700">Pick two different instruments</div>
            <div class="mini" style="margin-top:6px">(v1 ranks keys based on what tends to be easy across two *different* string setups.)</div>
          </div>`;
        }
        updateURL(false);
        return;
      }

      const instA = getInstrument(aId);
      const instB = getInstrument(bId);

      // Compute ranked results
      const ranked = keys
        .map(k => {
          const score = combinedScore(instA, instB, k);
          return { key:k, ...score };
        })
        .sort((x,y)=>y.combined - x.combined)
        .slice(0, 5);

      resultsEl.innerHTML = ranked.map((r, idx)=>renderKeyCard(r, instA, instB, idx)).join("");

      // Animate bars after insertion
      requestAnimationFrame(()=>{
        $$(".bar > i", resultsEl).forEach(iEl=>{
          const pct = iEl.getAttribute("data-pct") || "0";
          iEl.style.width = pct + "%";
        });
      });

      wireTabs();
      wireChordChips(instA, instB);

      updateURL(false);
    }

    function renderKeyCard(r, instA, instB, idx){
      const k = r.key;
      const relNotes = relativeMinorNotes(k);
      const diat = diatonicChordsMajor(k);
      const jam = jamSetForKey(k);

      // Why this works
      const whyA = explainWhy(instA, k, r.a);
      const whyB = explainWhy(instB, k, r.b);
      const why = [
        whyA ? `${instShort(instA)}: ${whyA}` : "",
        whyB ? `${instShort(instB)}: ${whyB}` : "",
        `key signature: ${k.sigText}`
      ].filter(Boolean).slice(0,3).join(" · ");

      // Safe notes chips (scale tones) w/ badges
      const safeNotes = k.scale;
      const chips = safeNotes.map(n=>{
        const badges = safeNoteBadges(n, instA, instB, k);
        const badgeHtml = badges.length
          ? `<span class="badges">${badges.map(b=>`<span class="badge ${b.ok?"ok":""}">${escapeHtml(b.txt)}</span>`).join("")}</span>`
          : `<span class="badges"></span>`;
        return `<span class="note-chip">${escapeHtml(n)} ${badgeHtml}</span>`;
      }).join("");

      const aBarPct = (r.a.ease0to10/10)*100;
      const bBarPct = (r.b.ease0to10/10)*100;

      const tabIdBase = `k${idx}_${k.id}`;

      return `
        <article class="card key-card" data-key="${escapeHtml(k.id)}">
          <div class="key-top">
            <div class="kname">
              <div class="big">${escapeHtml(k.major)} major <span style="color:var(--muted)">/</span> ${escapeHtml(k.relMinor)} minor</div>
              <div class="sub">Major scale: ${k.scale.map(escapeHtml).join(" ")} · Relative natural minor: ${relNotes.map(escapeHtml).join(" ")}</div>
            </div>
            <div class="score-pill" title="Combined score (0–100)">
              <span class="num">${Math.round(r.combined)}</span>
              <span class="lbl">combined / 100</span>
            </div>
          </div>

          <div class="why">Why this works: ${escapeHtml(why)}</div>

          <div class="bars">
            <div class="bar-row">
              <div class="tag">${escapeHtml(instShort(instA))}</div>
              <div class="bar" aria-label="${escapeHtml(instShort(instA))} score"><i data-pct="${aBarPct.toFixed(1)}"></i></div>
              <div class="val">${r.a.ease0to10.toFixed(1)}/10</div>
            </div>
            <div class="bar-row">
              <div class="tag">${escapeHtml(instShort(instB))}</div>
              <div class="bar" aria-label="${escapeHtml(instShort(instB))} score"><i data-pct="${bBarPct.toFixed(1)}"></i></div>
              <div class="val">${r.b.ease0to10.toFixed(1)}/10</div>
            </div>
          </div>

          <div class="chips" aria-label="Common tones / safe notes">
            ${chips}
          </div>

          <div class="tabs">
            <div class="tablist" role="tablist" aria-label="Key card tabs">
              <button class="tab" role="tab" aria-selected="true" data-tab="${tabIdBase}_chords">Chords</button>
              <button class="tab" role="tab" aria-selected="false" data-tab="${tabIdBase}_scale">Scale</button>
              <button class="tab" role="tab" aria-selected="false" data-tab="${tabIdBase}_fing">Fingerings</button>
            </div>

            <div class="tabpanel" role="tabpanel" id="${tabIdBase}_chords" data-panel>
              <div class="row2">
                <div>
                  <div class="section-title">Diatonic chords (major key)</div>
                  <div class="chord-grid">
                    ${diat.map(d=>`<button class="chord-chip" data-chord="${escapeHtml(d.name)}" data-allow="diat"><span class="deg">${escapeHtml(d.degree)}</span><span class="ch">${escapeHtml(d.name)}</span></button>`).join("")}
                  </div>
                  <div class="mini" style="margin-top:8px">Tap a chord to see a diagram (only for guitar/ukulele in v1).</div>
                </div>
                <div>
                  <div class="section-title">Jam set (I / IV / V / vi)</div>
                  <div class="chord-grid">
                    ${jam.map(d=>`<button class="chord-chip" data-chord="${escapeHtml(d.name)}" data-allow="jam"><span class="deg">${escapeHtml(d.degree)}</span><span class="ch">${escapeHtml(d.name)}</span></button>`).join("")}
                  </div>
                  <div class="mini" style="margin-top:8px">This is the quickest “start playing now” set for many pop/folk jams.</div>
                </div>
              </div>
            </div>

            <div class="tabpanel" role="tabpanel" id="${tabIdBase}_scale" data-panel hidden>
              <div class="row2">
                <div>
                  <div class="section-title">Major scale tones</div>
                  <div class="note-line">${k.scale.map(n=>`<span class="note-chip">${escapeHtml(n)}</span>`).join("")}</div>
                </div>
                <div>
                  <div class="section-title">Relative natural minor tones</div>
                  <div class="note-line">${relNotes.map(n=>`<span class="note-chip">${escapeHtml(n)}</span>`).join("")}</div>
                </div>
                <div style="grid-column: 1 / -1">
                  <div class="section-title">Safe notes (with open-string hints)</div>
                  <div class="note-line">${chips}</div>
                  <div class="mini" style="margin-top:8px">Badges mark tonic/dominant and whether a scale tone is an open string on Instrument A/B.</div>
                </div>
              </div>
            </div>

            <div class="tabpanel" role="tabpanel" id="${tabIdBase}_fing" data-panel hidden>
              <div class="row2">
                <div>
                  <div class="section-title">${escapeHtml(instShort(instA))}</div>
                  ${renderFingeringsForInstrument(instA, k)}
                </div>
                <div>
                  <div class="section-title">${escapeHtml(instShort(instB))}</div>
                  ${renderFingeringsForInstrument(instB, k)}
                </div>
              </div>
            </div>

          </div>
        </article>
      `;
    }

    function instShort(inst){
      if(!inst) return "";
      // Short labels
      const map = {
        guitar_std: "Guitar",
        guitar_dropd: "Guitar (Drop D)",
        ukulele: "Ukulele",
        bass: "Bass",
        violin: "Violin",
        viola: "Viola",
        cello: "Cello",
        double_bass: "Double Bass"
      };
      return map[inst.id] || inst.name;
    }

    function renderFingeringsForInstrument(inst, key){
      const jam = jamSetForKey(key);

      if(inst.id === "guitar_std" || inst.id === "guitar_dropd" || inst.id === "ukulele"){
        const instKey = (inst.id === "ukulele") ? "ukulele" : "guitar";
        const supported = jam.map(j => {
          const shape = (instKey==="guitar") ? chordShapes.guitar[j.name] : chordShapes.ukulele[j.name];
          return { chord: j.name, degree:j.degree, shape };
        });

        return `
          <div class="mini">Jam-chord diagrams for this key:</div>
          <div class="diagram-wrap" style="margin-top:10px">
            ${supported.map(s => {
              if(!s.shape) {
                return `
                  <div class="diagram-card">
                    <div class="diagram-head">
                      <div class="ttl">${escapeHtml(s.degree)} chord</div>
                      <div class="chname">${escapeHtml(s.chord)}</div>
                    </div>
                    <div class="mini">Shape not included in v1.</div>
                  </div>
                `;
              }
              // Canvas is injected after render.
              return `
                <div class="diagram-card" data-diagram data-inst="${escapeHtml(inst.id)}" data-chord="${escapeHtml(s.chord)}">
                  <div class="diagram-head">
                    <div class="ttl">${escapeHtml(s.degree)} chord</div>
                    <div class="chname">${escapeHtml(s.chord)}</div>
                  </div>
                  <div class="mini" style="margin-bottom:6px">Tap the chord chip above for a bigger view.</div>
                  <div class="cnv"></div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }

      // Bowed strings
      if(inst.family === "bowed"){
        return renderBowedFingerings(inst, key);
      }

      // Bass / Double bass
      if(inst.family === "bass"){
        const openInKey = inst.strings.filter(s => noteInScale(s, key.scale));
        const tonic = key.major;
        const domPc = (pc(tonic)+7)%12;
        const rootFriendly = [tonic, key.scale.find(n=>pc(n)===domPc), key.scale[3]] // tonic, dominant, subdominant
          .filter(Boolean);
        return `
          <div class="bowed-grid">
            <div class="kv"><b>Open strings</b><div>${inst.strings.map(n=>`<span class="note-chip">${escapeHtml(n)}</span>`).join(" ")}</div></div>
            <div class="kv"><b>Open strings in key</b><div>${openInKey.length ? openInKey.map(n=>`<span class="note-chip">${escapeHtml(n)}</span>`).join(" ") : `<span class="mini">None (still playable, just less “ringy”)</span>`}</div></div>
            <div class="kv"><b>Root-friendly notes</b><div>${uniq(rootFriendly).map(n=>`<span class="note-chip">${escapeHtml(n)}</span>`).join(" ")}</div></div>
            <div class="kv"><b>Practical hint</b><div class="mini">Start with roots on low open strings if they fit (especially E/A). Then add fifths and passing tones from the scale.</div></div>
          </div>
        `;
      }

      return `<div class="mini">No fingerings available for this instrument (v1).</div>`;
    }

    function wireTabs(){
      $$(".key-card", resultsEl).forEach(card => {
        const tabs = $$(".tab", card);
        const panels = $$("[data-panel]", card);

        tabs.forEach(t => {
          t.addEventListener("click", () => {
            const target = t.getAttribute("data-tab");
            tabs.forEach(x => x.setAttribute("aria-selected", x===t ? "true" : "false"));
            panels.forEach(p => {
              const isTarget = p.id === target;
              p.hidden = !isTarget;
            });
            // Inject chord diagrams if needed
            injectMiniDiagrams(card);
          });
        });

        // First render injection
        injectMiniDiagrams(card);
      });
    }

    function injectMiniDiagrams(card){
      // Render the mini chord diagrams in the Fingerings tab.
      const items = $$("[data-diagram]", card);
      items.forEach(item => {
        if(item.getAttribute("data-done")==="1") return;
        const instId = item.getAttribute("data-inst");
        const chord = item.getAttribute("data-chord");
        const inst = getInstrument(instId);
        const shape = shapeForInstrument(inst, chord);
        if(!shape) { item.setAttribute("data-done","1"); return; }
        const cnvWrap = $(".cnv", item);
        if(!cnvWrap) { item.setAttribute("data-done","1"); return; }
        renderChordDiagramCanvas(cnvWrap, inst, chord, shape);
        item.setAttribute("data-done","1");
      });
    }

    function wireChordChips(instA, instB){
      const dlg = $("#dlg");
      const dlgTitle = $("#dlgTitle");
      const dlgBody = $("#dlgBody");
      const closeBtn = $("#dlgCloseBtn");

      function openDialog(chord){
        dlgTitle.textContent = chord;
        dlgBody.innerHTML = "";

        const wrap = document.createElement("div");
        wrap.className = "diagram-wrap";

        // Determine which instruments can show diagrams
        const instrumentsToShow = [instA, instB].filter(Boolean);

        instrumentsToShow.forEach(inst => {
          const shape = shapeForInstrument(inst, chord);
          const card = document.createElement("div");
          card.className = "diagram-card";
          card.innerHTML = `
            <div class="diagram-head">
              <div class="ttl">${escapeHtml(instShort(inst))}</div>
              <div class="chname">${escapeHtml(chord)}</div>
            </div>
          `;

          if(!shape){
            card.insertAdjacentHTML("beforeend", `<div class="mini">Shape not included in v1.</div>`);
          } else {
            const cnv = document.createElement("div");
            card.appendChild(cnv);
            renderChordDiagramCanvas(cnv, inst, chord, shape);
          }

          wrap.appendChild(card);
        });

        dlgBody.appendChild(wrap);
        if(typeof dlg.showModal === "function") dlg.showModal();
        else dlg.setAttribute("open","open");
      }

      // Delegate clicks
      resultsEl.addEventListener("click", (e)=>{
        const btn = e.target.closest(".chord-chip");
        if(!btn) return;
        const chord = btn.getAttribute("data-chord");
        if(!chord) return;

        const canShow = [instA, instB].some(i => i && (i.id==="guitar_std" || i.id==="guitar_dropd" || i.id==="ukulele"));
        if(!canShow){
          toast("Chord diagrams are only included for guitar/ukulele in v1.");
          return;
        }
        openDialog(chord);
      });

      closeBtn.onclick = () => {
        if(dlg.open) dlg.close();
      };

      dlg.addEventListener("click", (e)=>{
        // Click outside card closes
        const rect = dlg.getBoundingClientRect();
        const inDialog = (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom);
        if(!inDialog) dlg.close();
      });
    }

    // -------------------------
    // URL params (share)
    // -------------------------

    function parseParams(){
      const sp = new URLSearchParams(location.search);
      const a = sp.get("a") || "";
      const b = sp.get("b") || "";
      // v1 only supports instruments.
      return {a,b};
    }

    function updateURL(push=true){
      const a = selA.value;
      const b = selB.value;
      const sp = new URLSearchParams();
      if(a) sp.set("a", a);
      if(b) sp.set("b", b);
      const newUrl = location.pathname + (sp.toString()?`?${sp.toString()}`:"") + location.hash;
      if(push) history.pushState({}, "", newUrl);
      else history.replaceState({}, "", newUrl);
    }

    async function copyShareLink(){
      const a = selA.value;
      const b = selB.value;
      if(!a || !b || a===b) return;
      const sp = new URLSearchParams({a,b});
      const url = location.origin + location.pathname + `?${sp.toString()}`;

      try{
        await navigator.clipboard.writeText(url);
        toast("Share link copied to clipboard.");
      } catch(err){
        // Fallback
        window.prompt("Copy this link:", url);
      }
    }

    // -------------------------
    // Init
    // -------------------------

    fillSelect(selA);
    fillSelect(selB);

    // Apply URL params if present
    const params = parseParams();
    if(params.a && instruments[params.a]) selA.value = params.a;
    if(params.b && instruments[params.b]) selB.value = params.b;

    selA.addEventListener("change", render);
    selB.addEventListener("change", render);

    swapBtn.addEventListener("click", ()=>{
      const a = selA.value;
      selA.value = selB.value;
      selB.value = a;
      toast("Swapped.");
      render();
    });

    shareBtn.addEventListener("click", copyShareLink);

    // React to back/forward
    window.addEventListener("popstate", ()=>{
      const p = parseParams();
      selA.value = instruments[p.a] ? p.a : "";
      selB.value = instruments[p.b] ? p.b : "";
      render();
    });

    // First render
    render();

  </script>
</body>
</html>
